/*!
 * BubbleUp
 * http://github.com/asaharan/bubbleUp
 * @licence MIT
*/
'use strict';

function StorageManager(){this.prefix="bubble",this.localStorage=window.localStorage}function Grid(){this.grid=[]}function InputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function HTMLActuator(){this.gameContainer=document.querySelector(".gameContainer"),this.gameContainerInner=document.querySelector(".gameContainerInner"),this.tileContainer=document.querySelector(".tileContainer")}function Tile(position,value){this.x=position.x,this.y=position.y,this.value=value,this.firedFrom=null,this.fireDirection=null,this.element_id=null,this.previousValue=null,this.nextValue=value}function GameManager(size,InputManager,Actuator,StorageManager){this.size=size,this.inputManager=new InputManager,this.storageManager=StorageManager,this.actuator=new Actuator,this.grid=new Grid,this.startNumber=512,this.identity=0,this.fixTile=null,this.inputManager.on("restart",this.restart.bind(this)),this.setup()}StorageManager.prototype.set=function(what,value){this.localStorage.what=value},Grid.prototype.clearContainer=function(){this.grid=[]},Grid.prototype.addTile=function(tile){this.grid.push(tile)},Grid.prototype.removeTile=function(id){var newGrid=[];this.grid.forEach(function(tile){tile.element_id!=id&&newGrid.push(tile)}),this.grid=[],this.grid=newGrid.slice()},Grid.prototype.findTileById=function(elementId){var tile=null;return this.grid.forEach(function(tilet){tilet.element_id==elementId&&(tile=tilet)}),tile},Grid.prototype.findTileByPosition=function(position){var tile=null;return this.grid.forEach(function(tilet){tilet.x==position.x&&tilet.y==position.y&&(tile=tilet)}),tile},Grid.prototype.getSplitElements=function(tile){return this.directions(tile)},Grid.prototype.directions=function(tile){var corner=this.isCorner(tile);if(corner)return this.makeChildTiles(tile,corner);var center=this.isCenter(tile);if(center)return this.makeChildTiles(tile,center);var edge=this.isEdge(tile);return edge?this.makeChildTiles(tile,edge):!1},Grid.prototype.makeChildTiles=function(tile,directions){var tiles=[],initPosition={x:tile.x,y:tile.y},childValue=this.splitValue(tile.value,2);return directions.forEach(function(direction){var tile=new Tile(initPosition,childValue);tile.firedFrom=initPosition,tile.fireDirection=direction,tiles.push(tile)}),tiles},Grid.prototype.splitValue=function(initialValue,parts){return parseInt(Math.floor(initialValue/parts))},Grid.prototype.isCorner=function(tile){return 0==tile.x&&0==tile.y?[directions.right,directions.down]:tile.x==size-1&&0==tile.y?[directions.left,directions.down]:0==tile.x&&tile.y==size-1?[directions.right,directions.up]:tile.x==size-1&&tile.y==size-1?[directions.left,directions.up]:!1},Grid.prototype.isCenter=function(tile){return tile.x>0&&tile.x<size-1&&tile.y>0&&tile.y<size-1?[directions.up,directions.right,directions.down,directions.left]:!1},Grid.prototype.isEdge=function(tile){return 0==tile.x&&tile.y>0&&tile.y<size-1?[directions.up,directions.right,directions.down]:tile.x==size-1&&tile.y>0&&tile.y<size-1?[directions.up,directions.down,directions.left]:0==tile.y&&tile.x>0&&tile.x<size-1?[directions.right,directions.down,directions.left]:tile.y==size-1&&tile.x>0&&tile.x<size-1?[directions.up,directions.right,directions.left]:void 0},InputManager.prototype.restart=function(event){event.stopPropagation(),event.preventDefault(),this.emit("restart")},InputManager.prototype.on=function(event,callback){this.events[event]||(this.events[event]=[]),this.events[event].push(callback)},InputManager.prototype.emit=function(event,data){var callbacks=this.events[event];callbacks&&callbacks.forEach(function(callback){callback(data)})},InputManager.prototype.listen=function(){document.querySelector(".tile");this.bindButtonPress(".newGame",this.restart)},InputManager.prototype.bindButtonPress=function(selector,fn){var button=document.querySelector(selector);button.addEventListener("click",fn.bind(this)),button.addEventListener(this.eventTouchend,fn.bind(this))},HTMLActuator.prototype.fireTile=function(tile,parent){var init={};init.x=tile.x,init.y=tile.y;var nextPosition=this.findNextPosition(init,tile.fireDirection,parent);if(null==nextPosition)this.eatUp(tile,parent);else{var tilePresentThere=parent.grid.findTileByPosition(nextPosition);tile.nextValue=tile.value+tilePresentThere.value,this.removeTile(tilePresentThere.element_id,parent),this.moveTile(tile,nextPosition,parent)}},HTMLActuator.prototype.eatUp=function(tile,parent){this.removeTile(tile.element_id,parent)},HTMLActuator.prototype.clearContainer=function(){this.tileContainer.textContent=""},HTMLActuator.prototype.findNextPosition=function(position,dir,parent){var toMerge=null,i=0;if(directions.right==dir){for(i=position.x+1;i<parent.size;i++)if(toMerge=parent.grid.findTileByPosition({x:i,y:position.y}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}if(directions.down==dir){for(i=position.y+1;i<parent.size;i++)if(toMerge=parent.grid.findTileByPosition({x:position.x,y:i}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}if(directions.left==dir){for(i=position.x-1;i>-1;i--)if(toMerge=parent.grid.findTileByPosition({x:i,y:position.y}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}if(directions.up==dir){for(i=position.y-1;i>=-1;i--)if(toMerge=parent.grid.findTileByPosition({x:position.x,y:i}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}},HTMLActuator.prototype.addTile=function(tile,parent,newTile){newTile=1==newTile;var wrapper=document.createElement("div"),inner=document.createElement("div"),clicker=document.createElement("div");inner.setAttribute("class","inner"),inner.textContent=tile.value,wrapper.appendChild(inner),clicker.setAttribute("class","clicker");var position=tile.previousPosition||{x:tile.x,y:tile.y},positionClass=this.positionClass(position),classes=["tile","tile"+this.valueClass(tile.value),positionClass];newTile&&classes.push("new"),this.applyClasses(wrapper,classes);var id=this.uniqueIdentity(parent);this.addIdentity(wrapper,id,!0),tile.element_id=id,this.addIdentity(clicker,id),wrapper.appendChild(clicker),this.tileContainer.appendChild(wrapper),parent.grid.addTile(tile),parent.inputManager.bindButtonPress(".clicker[data-id='"+id+"']",parent.split.bind(parent))},HTMLActuator.prototype.positionClass=function(position){return"tile-position-"+position.x+"-"+position.y},HTMLActuator.prototype.valueClass=function(value){return parseInt(100*Math.floor(value/100))},HTMLActuator.prototype.addIdentity=function(element,id,iswrapper){1!=iswrapper&&element.setAttribute("data-id",id.toString()),iswrapper&&element.setAttribute("id","tile-"+id.toString())},HTMLActuator.prototype.applyClasses=function(element,classes){element.setAttribute("class",classes.join(" "))},HTMLActuator.prototype.uniqueIdentity=function(parent){return parent.identity++,parent.identity},HTMLActuator.prototype.mergeTiles=function(firstTile,secondTile){},HTMLActuator.prototype.removeTile=function(tileId,parent){parent.grid.removeTile(tileId);var tileWrapper=document.getElementById("tile-"+tileId);this.removeElement(tileWrapper)},HTMLActuator.prototype.removeElement=function(element){window.requestAnimationFrame(function(){element.remove()})},HTMLActuator.prototype.moveTile=function(tile,nextPosition){var tileElement=document.getElementById("tile-"+tile.element_id);this.updateClasses(tileElement,this.positionClass(nextPosition)),tile.x=nextPosition.x,tile.y=nextPosition.y,tile.value=tile.nextValue,this.applyValue(tile)},HTMLActuator.prototype.updateClasses=function(element,classToUpdate){var self=this,elementClassList=element.className.split(" ");elementClassList[2]=classToUpdate,window.requestAnimationFrame(function(){self.applyClasses(element,elementClassList)})},HTMLActuator.prototype.applyValue=function(tile){var element=document.querySelector("#tile-"+tile.element_id+" > div.inner");element.textContent=tile.nextValue},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(position){this.x=position.x,this.y=position.y},Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}},Tile.prototype.fireIt=function(direction){},Tile.prototype.isFixed=function(parent){return parent.fixTile.x==this.x&&parent.fixTile.y==this.y?!0:!1};const directions={up:1,right:2,down:3,left:4};GameManager.prototype.setup=function(){this.storageManager.set("bestScore",1e3),this.actuator.clearContainer(),this.grid.clearContainer();for(var i=0;i<this.size;i++)for(var j=0;j<this.size;j++){var tile=new Tile({x:j,y:i},this.startNumber);this.actuator.addTile(tile,this,!0)}this.setFixedTile()},GameManager.prototype.setFixedTile=function(){var stylesheetId="AsAdnHajAhdAHAStylesheet",doesStyleSheetExist=document.getElementById(stylesheetId);(null!=doesStyleSheetExist||void 0!=doesStyleSheetExist)&&doesStyleSheetExist.parentNode.removeChild(doesStyleSheetExist),this.fixTile=this.grid.findTileByPosition(this.getRandomPosition());var stylesheet=document.createElement("style");stylesheet.textContent=".tile.tile-position-"+this.fixTile.x+"-"+this.fixTile.y+"{ box-shadow:0 0 30px 10px rgba(243, 215, 116, 0.96), inset 0 0 0 1px rgba(213, 123, 123, 1);}",stylesheet.setAttribute("id",stylesheetId),document.querySelector("body").appendChild(stylesheet)},GameManager.prototype.getRandomPosition=function(){var random={};return random.x=Math.floor(Math.random()*this.size),random.y=Math.floor(Math.random()*this.size),console.log(random),random},GameManager.prototype.restart=function(){this.setup()},GameManager.prototype.split=function(event){var self=this,id=parseInt(event.target.dataset.id),tile=this.grid.findTileById(id);if(!tile.isFixed(self)){var splitElements=this.grid.getSplitElements(tile);splitElements&&splitElements.forEach(function(element){self.actuator.removeTile(id,self),self.actuator.addTile(element,self),self.actuator.fireTile(element,self)})}};var size=4,game;window.requestAnimationFrame(function(){game=new GameManager(size,InputManager,HTMLActuator,StorageManager)});
//# sourceMappingURL=game.min.js.map