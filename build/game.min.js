/*!
 * BubbleUp
 * http://github.com/asaharan/bubbleUp
 * @licence MIT
*/
'use strict';

"use strict";function Grid(){this.grid=[]}function InputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function HTMLActuator(){this.gameContainer=document.querySelector(".gameContainer"),this.gameContainerInner=document.querySelector(".gameContainerInner"),this.tileContainer=document.querySelector(".tileContainer")}function Tile(position,value){this.x=position.x,this.y=position.y,this.value=value,this.firedFrom=null,this.fireDirection=null,this.element_id=null}function GameManager(size,InputManager,Actuator,StorageManager){this.size=size,this.inputManager=new InputManager,this.storagemanager=StorageManager,this.actuator=new HTMLActuator,this.grid=new Grid,this.startNumber=512,this.identity=0,this.inputManager.on("restart",this.restart.bind(this)),this.setup()}!function(){for(var lastTime=0,vendors=["webkit","moz"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}(),Grid.prototype.addTile=function(tile){this.grid.push(tile)},Grid.prototype.removeTile=function(id){var newGrid=[];this.grid.forEach(function(tile){tile.element_id!=id&&newGrid.push(tile)}),this.grid=[],this.grid=newGrid.slice()},Grid.prototype.findTileById=function(elementId){var tile=null;return this.grid.forEach(function(tilet){tilet.element_id==elementId&&(tile=tilet)}),tile},Grid.prototype.findTileByPosition=function(position){var tile=null;return this.grid.forEach(function(tilet){tilet.x==position.x&&tilet.y==position.y&&(tile=tilet)}),tile},Grid.prototype.getSplitElements=function(tile){return this.directions(tile)},Grid.prototype.directions=function(tile){var corner=this.isCorner(tile);if(corner)return this.makeChildTiles(tile,corner);var center=this.isCenter(tile);if(center)return this.makeChildTiles(tile,center);var edge=this.isEdge(tile);return edge?this.makeChildTiles(tile,edge):!1},Grid.prototype.makeChildTiles=function(tile,directions){var tiles=[],initPosition={x:tile.x,y:tile.y},childValue=this.splitValue(tile.value,2);return directions.forEach(function(direction){var tile=new Tile(initPosition,childValue);tile.firedFrom=initPosition,tile.fireDirection=direction,tiles.push(tile)}),tiles},Grid.prototype.splitValue=function(initialValue,parts){return parseInt(Math.floor(initialValue/parts))},Grid.prototype.isCorner=function(tile){return 0==tile.x&&0==tile.y?[directions.right,directions.down]:3==tile.x&&0==tile.y?[directions.left,directions.down]:0==tile.x&&3==tile.y?[directions.right,directions.up]:3==tile.x&&3==tile.y?[directions.left,directions.up]:!1},Grid.prototype.isCenter=function(tile){return tile.x>0&&tile.x<size-1&&tile.y>0&&tile.y<size-1?[directions.up,directions.right,directions.down,directions.left]:!1},Grid.prototype.isEdge=function(tile){return 0!=tile.x||1!=tile.y&&2!=tile.y?3!=tile.x||1!=tile.y&&2!=tile.y?0!=tile.y||1!=tile.x&&2!=tile.x?3!=tile.y||1!=tile.x&&2!=tile.x?void 0:[directions.top,directions.right,directions.left]:[directions.right,directions.down,directions.left]:[directions.up,directions.down,directions.left]:[directions.up,directions.right,directions.down]},InputManager.prototype.restart=function(event){event.stopPropagation(),event.preventDefault(),this.emit("restart")},InputManager.prototype.on=function(event,callback){this.events[event]||(this.events[event]=[]),this.events[event].push(callback)},InputManager.prototype.emit=function(event,data){console.log(event,data,"emited");var callbacks=this.events[event];callbacks&&callbacks.forEach(function(callback){callback(data)})},InputManager.prototype.listen=function(){document.querySelector(".tile");this.bindButtonPress(".newGame",this.restart)},InputManager.prototype.bindButtonPress=function(selector,fn){var button=document.querySelector(selector);button.addEventListener("click",fn.bind(this)),button.addEventListener(this.eventTouchend,fn.bind(this))},HTMLActuator.prototype.fireTile=function(tile,parent){var init={};init.x=tile.x,init.y=tile.y;var nextPosition=this.findNextPosition(init,tile.fireDirection,parent);if(null==nextPosition)this.eatUp(tile,parent);else{var tilePresentThere=parent.grid.findTileByPosition();console.log("removing ",tilePresentThere),this.removeTile(tilePresentThere.element_id,parent),this.moveTile(tile,nextPosition,parent)}},HTMLActuator.prototype.eatUp=function(tile,parent){this.removeTile(tile.element_id,parent)},HTMLActuator.prototype.findNextPosition=function(position,dir,parent){var toMerge=null,i=0;if(directions.right==dir){for(i=position.x+1;i<parent.size;i++)if(toMerge=parent.grid.findTileByPosition({x:i,y:position.y}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}if(directions.down==dir){for(i=position.y+1;i<parent.size;i++)if(toMerge=parent.grid.findTileByPosition({x:position.x,y:i}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}if(directions.left==dir){for(i=position.x-1;i>-1;i--)if(toMerge=parent.grid.findTileByPosition({x:i,y:position.y}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}if(directions.up==dir){for(i=position.y-1;i>=-1;i--)if(toMerge=parent.grid.findTileByPosition({x:position.x,y:i}),null!=toMerge)return{x:toMerge.x,y:toMerge.y};return null}},HTMLActuator.prototype.addTile=function(tile,parent){var wrapper=document.createElement("div"),inner=document.createElement("div"),clicker=document.createElement("div");inner.setAttribute("class","inner"),inner.textContent=tile.value,wrapper.appendChild(inner),clicker.setAttribute("class","clicker");var position=tile.previousPosition||{x:tile.x,y:tile.y},positionClass=this.positionClass(position),classes=["tile","tile"+this.valueClass(tile.value),positionClass,"new"];this.applyClasses(wrapper,classes);var id=this.uniqueIdentity(parent);this.addIdentity(wrapper,id,!0),tile.element_id=id,this.addIdentity(clicker,id),wrapper.appendChild(clicker),this.tileContainer.appendChild(wrapper),parent.grid.addTile(tile),parent.inputManager.bindButtonPress(".clicker[data-id='"+id+"']",parent.split.bind(parent))},HTMLActuator.prototype.positionClass=function(position){return"tile-position-"+position.x+"-"+position.y},HTMLActuator.prototype.valueClass=function(value){return parseInt(100*Math.floor(value/100))},HTMLActuator.prototype.addIdentity=function(element,id,iswrapper){1!=iswrapper&&element.setAttribute("data-id",id.toString()),iswrapper&&element.setAttribute("id","tile-"+id.toString())},HTMLActuator.prototype.applyClasses=function(element,classes){element.setAttribute("class",classes.join(" "))},HTMLActuator.prototype.uniqueIdentity=function(parent){return parent.identity++,parent.identity},HTMLActuator.prototype.mergeTiles=function(firstTile,secondTile){},HTMLActuator.prototype.removeTile=function(tileId,parent){parent.grid.removeTile(tileId);var tileWrapper=document.getElementById("tile-"+tileId);this.removeElement(tileWrapper)},HTMLActuator.prototype.removeElement=function(element){window.requestAnimationFrame(function(){element.remove()})},HTMLActuator.prototype.moveTile=function(tile,nextPosition){var tileElement=document.getElementById("tile-"+tile.element_id);this.updateClasses(tileElement,this.positionClass(nextPosition)),tile.x=nextPosition.x,tile.y=nextPosition.y},HTMLActuator.prototype.updateClasses=function(element,classToUpdate){var self=this,elementClassList=element.className.split(" ");elementClassList[2]=classToUpdate,window.requestAnimationFrame(function(){self.applyClasses(element,elementClassList)})},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(position){this.x=position.x,this.y=position.y},Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}},Tile.prototype.fireIt=function(direction){};const directions={up:1,right:2,down:3,left:4};GameManager.prototype.setup=function(){for(var i=0;4>i;i++)for(var j=0;4>j;j++)if(!(0==i&&j>0&&3!=j)){var tile=new Tile({x:j,y:i},this.startNumber);this.actuator.addTile(tile,this)}},GameManager.prototype.restart=function(){},GameManager.prototype.split=function(event){var self=this,id=parseInt(event.target.dataset.id),tile=this.grid.findTileById(id),splitElements=this.grid.getSplitElements(tile);splitElements&&splitElements.forEach(function(element){self.actuator.removeTile(id,self),self.actuator.addTile(element,self),self.actuator.fireTile(element,self)})};var size=4,game;window.requestAnimationFrame(function(){game=new GameManager(size,InputManager,1,1)});
//# sourceMappingURL=game.min.js.map